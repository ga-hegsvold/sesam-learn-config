{
  "_id": "hubspot-contact-company-enrich",
  "type": "pipe",
  "source": {
    "type": "dataset",
    "dataset": "hubspot-contact-enrich"
  },
  "transform": [{
    "type": "dtl",
    "rules": {
      "default": [
        ["comment", "Create a new entity for each NI."],
        ["create",
          ["filter",
            ["is-not-null", "_."],
            ["map",
              ["if",
                ["and",
                  ["is-ni",
                    ["sorted-descending", "_.value"]
                  ],
                  ["matches", "*hubspot-contact-company*",
                    ["ni-ns", "_.value"]
                  ],
                  ["eq", "ni",
                    ["last",
                      ["split", "-", "_.key"]
                    ]
                  ]
                ],
                ["if",
                  ["is-list", "_.value"],
                  ["apply", "create-ni-from-list", "_."],
                  ["dict", "_id", "foo", "$children",
                    ["list",
                      ["apply", "create-ni", "_.value"]
                    ]
                  ]
                ]
              ],
              ["key-values", "_S."]
            ]
          ]
        ],
        ["discard"]
      ],
      "create-ni": [
        ["add", "_id",
          ["concat",
            ["ni-ns",
              ["first", "_S."]
            ], ":",
            ["ni-id", "_S."]
          ]
        ],
        ["add", "rdf:type",
          ["ni",
            ["replace", "hubspot-", "hubspot:",
              ["ni-ns", "_S."]
            ]
          ]
        ],
        ["add",
          ["concat",
            ["ni-ns", "_S."], ":value"],
          ["ni-id", "_S."]
        ]
      ],
      "create-ni-from-list": [
        ["add", "_id", "foo"],
        ["create-child",
          ["apply", "create-ni", "_S.value"]
        ]
      ]
    }
  }, {
    "type": "emit_children"
  }]
}
